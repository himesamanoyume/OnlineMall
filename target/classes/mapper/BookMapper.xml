<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="design.princessdreamland.onlinemall.mapper.BookMapper">
    <resultMap id="bookMap" type="design.princessdreamland.onlinemall.entity.Book">
        <id property="bookId" column="book_id"/>

        <association property="seller" columnPrefix="su_">
            <id property="userId" column="user_id"/>
        </association>
        <association property="createUser" columnPrefix="cu_">
            <id property="userId" column="user_id"/>
        </association>
        <association property="updateUser" columnPrefix="uu_">
            <id property="userId" column="user_id"/>
        </association>

    </resultMap>

    <resultMap id="bookWithImgMap" type="design.princessdreamland.onlinemall.entity.Book">
        <id property="bookId" column="book_id"/>

        <association property="seller" columnPrefix="su_">
            <id property="userId" column="user_id"/>
        </association>
        <association property="createUser" columnPrefix="cu_">
            <id property="userId" column="user_id"/>
        </association>
        <association property="updateUser" columnPrefix="uu_">
            <id property="userId" column="user_id"/>
        </association>
        <collection property="srcList" columnPrefix="bi_" ofType="BookImg">
            <id property="bookImgId" column="book_img_id"/>
        </collection>
    </resultMap>

    <sql id="cols">
        b.book_id,
        b.name,
        b.price,
        b.author,
        b.amount,
        b.txt,
        b.seller_id,
        b.stock,
        b.publisher,
        b.publish_time,
        b.status,
        b.deleted,
        b.create_user_id,
	    b.create_time,
        b.update_user_id,
        b.update_time,

        su.user_id su_user_id,
        su.account su_account,
        su.name su_name,
        su.type su_type,
        su.address su_address,

        cu.user_id cu_user_id,
        cu.account cu_account,
        cu.name cu_name,
        cu.type cu_type,
        cu.address cu_address,

        uu.user_id uu_user_id,
        uu.account uu_account,
        uu.name uu_name,
        uu.type uu_type,
        uu.address uu_address

    </sql>
    <sql id="where">
        <where>
            AND b.deleted = 0
            <if test="book!=null and book!= ''">
                <if test="book.bookId!=null and book.bookId!=''">
                    AND b.book_id = #{book.bookId}
                </if>
                <if test="book.name!=null and book.name!=''">
                    AND b.name LIKE CONCAT('%',#{book.name},'%')
                </if>
                <if test="book.price!=null and book.price!=''">
                    AND b.price =#{book.price}
                </if>
                <if test="book.author!=null and book.author!=''">
                    AND b.author LIKE CONCAT('%',#{book.author},'%')
                </if>
                <if test="book.amount!=null and book.amount!=''">
                    AND b.amount =#{book.amount}
                </if>
                <if test="book.txt!=null and book.txt!=''">
                    AND b.txt LIKE CONCAT('%',#{book.txt},'%')
                </if>
                <if test="book.sellerId!=null and book.sellerId!=''">
                    AND b.seller_id LIKE CONCAT('%',#{book.sellerId},'%')
                </if>
                <if test="book.publisher!=null and book.publisher!=''">
                    AND b.publisher LIKE CONCAT('%',#{book.publisher},'%')
                </if>
                <if test="book.publishTime!=null and book.publishTime!=''">
                    AND b.publish_time LIKE CONCAT('%',#{book.publishTime},'%')
                </if>
                <if test="book.status!=null and book.status!=''">
                    AND b.status LIKE CONCAT('%',#{book.status},'%')
                </if>
            </if>
        </where>
    </sql>

    <select id="queryList" resultMap="bookMap">
        SELECT
        <include refid="cols" />,
        (select img_src from book_img bi
        where bi.book_id = b.book_id
        order by bi.book_img_id asc
        limit 0,1
        ) img_src
        FROM book b
        LEFT JOIN user su ON su.user_id = b.6seller_id AND su.deleted = 0
        LEFT JOIN user cu ON cu.user_id = b.create_user_id AND cu.deleted = 0
        LEFT JOIN user uu ON uu.user_id = b.update_user_id AND uu.deleted = 0

        <include refid="where" />

        ORDER BY b.book_id DESC

    </select>

    <select id="queryPage" resultMap="bookMap" >
        SELECT
        <include refid="cols" />,
        (select img_src from book_img bi
            where bi.book_id = b.book_id
            order by bi.book_img_id asc
            limit 0,1
        ) img_src

        FROM book b
        LEFT JOIN user su ON su.user_id = b.seller_id AND su.deleted = 0
        LEFT JOIN user cu ON cu.user_id = b.create_user_id AND cu.deleted = 0
        LEFT JOIN user uu ON uu.user_id = b.update_user_id AND uu.deleted = 0

        <include refid="where" />

        ORDER BY b.book_id DESC
    </select>

    <select id="queryById" resultMap="bookWithImgMap">
        SELECT
        <include refid="cols" />,
        (select img_src from book_img bi
        where bi.book_id = b.book_id
        order by bi.book_img_id asc
        limit 0,1
        ) img_src,
        bi.book_img_id bi_book_img_id,
        bi.book_id bi_book_id,
        bi.img_src bi_img_src,
        bi.deleted bi_deleted

        FROM book b
        LEFT JOIN user su ON su.user_id = b.seller_id AND su.deleted = 0
        LEFT JOIN user cu ON cu.user_id = b.create_user_id AND cu.deleted = 0
        LEFT JOIN user uu ON uu.user_id = b.update_user_id AND uu.deleted = 0
        LEFT JOIN book_img bi ON bi.book_id = b.book_id AND bi.deleted = 0


        WHERE b.book_id = #{bookId}

        ORDER BY b.book_id DESC

    </select>
</mapper>